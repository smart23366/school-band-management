<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡∏ß‡∏á‡πÇ‡∏¢‡∏ò‡∏ß‡∏≤‡∏ó‡∏¥‡∏ï</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 30px; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">‡∏ß‡∏á‡πÇ‡∏¢‡∏ò‡∏ß‡∏≤‡∏ó‡∏¥‡∏ï‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏™‡∏á‡∏ó‡∏≠‡∏á</a>
            <button class="btn btn-outline-light" id="adminLoginBtn" data-bs-toggle="modal" data-bs-target="#adminLoginModal">
                <i class="fas fa-user-lock me-2"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin
            </button>
        </div>
    </nav>

    <div class="container">
        <div class="card p-4">
            <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="late-tab" data-bs-toggle="tab" data-bs-target="#late" type="button" role="tab" aria-controls="late" aria-selected="true">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢</button>
                </li>
            </ul>
            
            <div class="tab-content" id="dataTabsContent">
                <div class="tab-pane fade show active" id="late" role="tabpanel" aria-labelledby="late-tab">
                    <h5 class="mt-3">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢</h5>
                    <form id="lateRecordForm">
                        <div class="mb-3">
                            <label for="employee_name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
                            <input type="text" class="form-control" id="late_employee_name" required>
                        </div>
                        <div class="mb-3">
                            <label for="record_date" class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <input type="date" class="form-control" id="late_record_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="detail" class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</label>
                            <textarea class="form-control" id="late_detail" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢</button>
                    </form>

                    <h5 class="mt-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h5>
                    <div id="lateRecordsDisplay" class="table-responsive">
                        <p class="text-muted" id="lateDataStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="adminLoginModal" tabindex="-1" aria-labelledby="adminLoginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adminLoginModalLabel">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="loginForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" value="admin" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- API Constants ---
        // üö®üö® ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà URL ‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ URL ‡πÉ‡∏´‡∏°‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì Deploy ‡πÉ‡∏ô Google Apps Script üö®üö®
        const API_URL = 'https://script.google.com/macros/s/AKfycbzsYj0ad_zCBf-JG0WylsQbfA60-_uOR0K3co8fizSXAXOQmgoVh8vbSkiu8hspmoVfnA/exec';
        const ADMIN_KEY = 'isAdminLoggedIn';
        const ADMIN_USER = 'admin';
        // (‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™ Hash ‡πÅ‡∏•‡∏∞ Login Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ)
        const DEFAULT_ADMIN_PASS_HASH = '40b28ee0d6c8d9f9cc05c9797de3cf170be0c88144cb47f89cc6af7da3873701'; 
        
        // --- Security Function: SHA-256 Hashing ---
        async function sha256(str) {
            const buffer = new TextEncoder().encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // (Login/Logout Logic Omitted for brevity, assuming it works)
        function isAdmin() { return sessionStorage.getItem(ADMIN_KEY) === 'true'; }
        // Note: You need to re-implement updateAdminUI and loginAdmin functions fully here.
        // For testing, we focus on API calls.
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            // Basic mock login for testing POST functionality
            Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡πÅ‡∏•‡πâ‡∏ß', 'success');
            sessionStorage.setItem(ADMIN_KEY, 'true');
            bootstrap.Modal.getInstance(document.getElementById('adminLoginModal')).hide();
        });


        // --- API GET Function (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•) ---
        async function fetchRecords(sheetName) {
            const url = `${API_URL}?action=get&sheet=${sheetName}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === 'success' || Array.isArray(data.data)) {
                    return data.data || [];
                }
                console.error(`API Fetch Error for ${sheetName}:`, data.message || 'Invalid data format');
                return [];
            } catch (error) {
                console.error(`Error fetching ${sheetName}:`, error);
                return [];
            }
        }
        
        // --- API POST Function (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ FAILED TO FETCH) ---
        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ POST ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script API
         * @param {string} action - ‡∏ä‡∏∑‡πà‡∏≠ action ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ doPost(e) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 'addRecord')
         * @param {object} payload - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ (‡πÄ‡∏ä‡πà‡∏ô sheetName, values)
         */
        async function sendDataToApi(action, payload) {
            const url = API_URL; 
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    // üö® ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î Content-Type ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS/Failed to fetch ‡πÉ‡∏ô POST Request
                    headers: {
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ action: action, payload: payload }) 
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data && data.status === 'error' || data.startsWith("Error:")) {
                    throw new Error(data.message || data);
                }
                
                return { success: true, message: data };

            } catch (error) {
                console.error(`Error during API POST (${action}):`, error);
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                return { success: false, message: error.message };
            }
        }
        
        // --- Form Submission Handler ---
        document.getElementById('lateRecordForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Login (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
            if (!isAdmin()) {
                Swal.fire('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'warning');
                return;
            }
            
            const employee_name = document.getElementById('late_employee_name').value;
            const record_date = document.getElementById('late_record_date').value;
            const detail = document.getElementById('late_detail').value;
            
            // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Apps Script (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Sheet: id, record_date, employee_name, detail)
            // id: ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ Date.now() ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ ID ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            const values = [
                Date.now(), 
                record_date, 
                employee_name, 
                detail
            ];

            const payload = {
                sheetName: 'LATE', // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏µ‡∏ó‡πÉ‡∏ô Google Sheet
                values: values
            };

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });
            
            const result = await sendDataToApi('addRecord', payload);

            if (result.success) {
                Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡∏°‡∏≤‡∏™‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                document.getElementById('lateRecordForm').reset();
                displayLateRecords(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            } else {
                // ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô sendDataToApi ‡πÅ‡∏•‡πâ‡∏ß
            }
        });

        // --- Data Display Function (‡∏ï‡∏≤‡∏£‡∏≤‡∏á) ---
        async function displayLateRecords() {
            document.getElementById('lateDataStatus').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            
            const records = await fetchRecords('LATE');
            const displayElement = document.getElementById('lateRecordsDisplay');
            
            if (records.length === 0) {
                displayElement.innerHTML = '<p class="text-muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏°‡∏≤‡∏™‡∏≤‡∏¢</p>';
                return;
            }
            
            let html = `
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
                            <th>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            records.slice(0, 10).forEach(record => { // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà 10 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                html += `
                    <tr>
                        <td>${record.id}</td>
                        <td>${record.record_date}</td>
                        <td>${record.employee_name}</td>
                        <td>${record.detail}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå')">‡∏•‡∏ö</button></td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;
            
            displayElement.innerHTML = html;
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            displayLateRecords();
        });

    </script>
</body>
</html>
